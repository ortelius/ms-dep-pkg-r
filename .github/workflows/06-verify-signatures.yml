name: 06 - Verify Signatures

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Container image name'
        required: true
      image_digest:
        description: 'Image digest'
        required: true
      registry:
        description: 'Container registry'
        required: true
        default: 'ghcr.io'
      verify_signature:
        description: 'Verify image signature'
        required: false
        default: 'true'
      verify_sbom_attestation:
        description: 'Verify SBOM attestation'
        required: false
        default: 'true'
      verify_provenance:
        description: 'Verify provenance'
        required: false
        default: 'false'

permissions:
  contents: read
  packages: read

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      
      - name: Login to registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ inputs.registry }} -u ${{ github.actor }} --password-stdin
      
      - name: Verify signature
        if: inputs.verify_signature == 'true'
        id: verify_sig
        env:
          IMAGE_URI: ${{ inputs.registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}
        run: |
          if cosign verify \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${IMAGE_URI}; then
            echo "signature_verified=true" >> $GITHUB_OUTPUT
          else
            echo "signature_verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Verify SBOM attestation
        if: inputs.verify_sbom_attestation == 'true'
        id: verify_sbom
        env:
          IMAGE_URI: ${{ inputs.registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}
        run: |
          if cosign verify-attestation \
            --type cyclonedx \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${IMAGE_URI}; then
            echo "sbom_verified=true" >> $GITHUB_OUTPUT
          else
            echo "sbom_verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Create verification summary
        run: |
          cat > verification-summary.json << EOL
          {
            "all_verified": true,
            "signature_verified": ${{ steps.verify_sig.outputs.signature_verified || 'false' }},
            "sbom_verified": ${{ steps.verify_sbom.outputs.sbom_verified || 'false' }},
            "image_digest": "${{ inputs.image_digest }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOL
          cat verification-summary.json
      
      - name: Upload verification results
        uses: actions/upload-artifact@v4
        with:
          name: verification-results-${{ github.run_id }}
          path: verification-summary.json
          retention-days: 90
      
      - name: Summary
        run: |
          echo "## Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Signature Verified: ${{ steps.verify_sig.outputs.signature_verified }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ SBOM Verified: ${{ steps.verify_sbom.outputs.sbom_verified }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image: \`${{ inputs.registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}\`" >> $GITHUB_STEP_SUMMARY
