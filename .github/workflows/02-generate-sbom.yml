---
name: 02 - Generate SBOM

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: "Container image name"
        required: true
      image_digest:
        description: "Image digest"
        required: true
      registry:
        description: "Container registry"
        required: true
        default: "ghcr.io"
      sbom_format:
        description: "SBOM format"
        required: false
        default: "cyclonedx-json"

permissions:
  contents: read
  packages: read

jobs:
  generate-sbom:
    runs-on: ubuntu-latest

    steps:
      - name: Install Trivy
        run: |
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install trivy

      - name: Login to registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ inputs.registry }} -u ${{ github.actor }} --password-stdin

      - name: Generate SBOM
        run: |
          trivy image \
            --format ${{ inputs.sbom_format }} \
            --output sbom.cyclonedx.json \
            ${{ inputs.registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}

      - name: Output SBOM metadata
        run: |
          cat > sbom-metadata.json << EOL
          {
            "sbom_path": "sbom.cyclonedx.json",
            "format": "${{ inputs.sbom_format }}",
            "image_digest": "${{ inputs.image_digest }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOL
          cat sbom-metadata.json

      - name: Upload SBOM
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: sbom-${{ github.run_id }}
          path: |
            sbom.cyclonedx.json
            sbom-metadata.json
          retention-days: 90
