name: 05 - Attest SBOM

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Container image name'
        required: true
      image_digest:
        description: 'Image digest'
        required: true
      registry:
        description: 'Container registry'
        required: true
        default: 'ghcr.io'
      sbom_artifact_name:
        description: 'SBOM artifact name'
        required: true
      sbom_workflow_run_id:
        description: 'SBOM workflow run ID'
        required: true

permissions:
  contents: read
  packages: write
  id-token: write  # Required for keyless signing with OIDC
  actions: read

jobs:
  attest:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3
      
      - name: Download SBOM artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.sbom_artifact_name }}
          run-id: ${{ inputs.sbom_workflow_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Login to registry
        run: |
          echo ${{ secrets.GITHUB_TOKEN }} | docker login ${{ inputs.registry }} -u ${{ github.actor }} --password-stdin
      
      - name: Attest SBOM (Keyless)
        env:
          IMAGE_URI: ${{ inputs.registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}
        run: |
          # Keyless attestation with Fulcio and Rekor
          # --yes flag automatically accepts ephemeral key generation
          cosign attest --yes \
            --type cyclonedx \
            --predicate sbom.cyclonedx.json \
            ${IMAGE_URI}
      
      - name: Verify attestation
        env:
          IMAGE_URI: ${{ inputs.registry }}/${{ inputs.image_name }}@${{ inputs.image_digest }}
        run: |
          # Verify attestation with certificate identity
          cosign verify-attestation \
            --type cyclonedx \
            --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
            --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
            ${IMAGE_URI} | tee attestation-verify.json
      
      - name: Output attestation info
        run: |
          cat > attestation-output.json << EOL
          {
            "image_digest": "${{ inputs.image_digest }}",
            "attested": true,
            "type": "cyclonedx",
            "method": "keyless",
            "certificate_identity": "https://github.com/${{ github.repository }}",
            "oidc_issuer": "https://token.actions.githubusercontent.com",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOL
          cat attestation-output.json
      
      - name: Upload attestation output
        uses: actions/upload-artifact@v4
        with:
          name: attestation-output-${{ github.run_id }}
          path: |
            attestation-output.json
            attestation-verify.json
          retention-days: 90
