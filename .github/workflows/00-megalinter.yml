name: 00 - MegaLinter

"on":
  workflow_dispatch:
    inputs:
      ref:
        description: "Git reference to lint"
        required: false
        default: "main"

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  megalinter:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: MegaLinter
        id: ml
        uses: oxsecurity/megalinter@v8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Enable JSON reporting for extraction
          JSON_REPORTER: true
          # Ensure detailed information is available for Claude
          JSON_REPORTER_OUTPUT_DETAIL: "detailed"
        # Continue to summary step even if linting finds errors
        continue-on-error: true

      - name: Upload MegaLinter reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: megalinter-reports-${{ github.run_id }}
          path: |
            megalinter-reports/
          retention-days: 30

      - name: Create detailed summary
        if: always()
        run: |
          REPORT="megalinter-reports/megalinter-report.json"
          
          # Handle case where report might be missing due to early exit
          if [ ! -f "$REPORT" ]; then
            echo "{\"status\": \"error\", \"message\": \"MegaLinter report not found\"}" > lint-summary.json
            exit 0
          fi

          # 1. Extract high-level summary stats
          STATUS="${{ steps.ml.outcome }}"
          LINTERS_RUN=$(jq '.summary.linters_run // 0' $REPORT)
          LINTERS_FAILED=$(jq '.summary.linters_failed // 0' $REPORT)
          TOTAL_ERRORS=$(jq '.summary.total_errors // 0' $REPORT)
          
          # 2. Extract detailed errors for Claude
          # This filter collects file path, line number, and error message
          ERROR_DETAILS=$(jq -c '[.linters[] | select(.status == "error") | .found_errors[]? | {file: .file, line: .line, message: .message, linter: .linter_name}]' $REPORT)

          # 3. Build the unified summary artifact
          cat > lint-summary.json << EOL
          {
            "status": "$STATUS",
            "linters_run": $LINTERS_RUN,
            "linters_failed": $LINTERS_FAILED,
            "errors_count": $TOTAL_ERRORS,
            "errors": $ERROR_DETAILS,
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOL
          
          echo "Generated lint-summary.json:"
          cat lint-summary.json

      - name: Upload summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-summary-${{ github.run_id }}
          path: lint-summary.json
          retention-days: 30

      - name: Check linting status
        if: always()
        run: |
          # Fail the workflow if any errors were found so the Orchestrator takes notice
          TOTAL_ERRORS=$(jq '.errors_count' lint-summary.json)
          if [ "$TOTAL_ERRORS" -gt 0 ]; then
            echo "âŒ MegaLinter found $TOTAL_ERRORS issues. Orchestrator will attempt auto-fix."
            exit 1
          fi